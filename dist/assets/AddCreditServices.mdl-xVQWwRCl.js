import{_ as xe,r as u,aa as G,a8 as H,k as B,j as De,m as j,o as m,w as q,c as U,n as k,a as n,t as D,d as b,X as ae,Y as M,S as we,F as z,C as te,D as V,e as $,B as se,ad as ie,s as Ne,P as Se,ag as _e,ah as Ce,T as R,ai as Ie,Z as re,h as ke,$ as Ee,aj as Te,ak as de,al as Pe,a3 as Ae,N as Fe,u as qe,b as ne,M as Be}from"./index-BA4ml571.js";import{_ as $e,s as Re}from"./EmployeeDetails.vue_vue_type_script_setup_true_lang-bllcUb56.js";const Me={key:0,class:"py-3 space-y-6 flex flex-col h-full"},Ve={key:0,class:"p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"},je={class:"flex gap-4"},Oe={class:"w-72"},Qe={key:0,class:"w-72"},He={class:"w-full"},ze={class:"mt-4 flex-1 flex flex-col"},Ge={key:0,class:"flex justify-center py-8"},Le={key:1,class:"border rounded-lg flex-1 flex flex-col"},We={class:"overflow-auto",style:{"max-height":"calc(100vh - 350px)","min-height":"300px"}},Xe={class:"min-w-full divide-y divide-gray-200"},Ye={class:"bg-white divide-y divide-gray-200"},Ze={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},Je={class:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"},Ke={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},ea={class:"px-6 py-4 whitespace-nowrap text-sm font-medium"},aa=["onClick"],ta={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 pl-10"},sa={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},ia={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 pl-2"},na={class:"text-xs text-blue-600 ml-1"},ra={class:"px-6 py-4 whitespace-nowrap text-sm font-medium"},da=["onClick"],la={key:1,class:"pt-4 px-6 border-t border-[#DFDEF2] flex justify-end space-x-4"},ua={key:1,class:"py-3 space-y-6"},oa={key:0,class:"p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"},ca={class:"grid grid-cols-1 md:grid-cols-3 gap-6 mt-6"},pa={class:"pt-4 px-6 border-t border-[#DFDEF2] flex justify-end space-x-4"},va={__name:"creditServicesForm",props:{initialData:{type:Object,default:()=>({})},isEdit:{type:Boolean,default:!1},pending:{type:Boolean,default:!1},onSubmit:{type:Function,required:!0},onCancel:{type:Function,required:!0}},setup(N){var K,ee;const E=N,C=u([]),x=u([]),g=u(null),a=u(null),y=u(null),r=u(""),p=u(!1),l=u(null),S=u("selectEmployee"),h=u("services"),v=u([]),d=u([]),T=u(""),P=u(""),w=G(),_=u(((ee=(K=w.auth)==null?void 0:K.user)==null?void 0:ee.providerUuid)||""),o=u(""),f=u(""),A=u(new Date().toISOString().split("T")[0]),L=u({}),O=u(null),W=H(()=>a.value?{fullName:a.value.fullName,employeeId:a.value.membershipNumber,role:a.value.position,phone:a.value.phone,insuredUuid:a.value.insuredUuid,email:a.value.email||"N/A",gender:a.value.gender||"Unknown",address:a.value.address||"Unknown",idNumber:a.value.membershipNumber,birthDate:a.value.birthDate||"Unknown",status:a.value.status||"ACTIVE",profilePicture:a.value.profilePictureBase64,isDependant:a.value.isDependant||!1,relationshipType:a.value.relationshipType||"",employeeUuid:a.value.employeeUuid||""}:null),le=H(()=>C.value.map(t=>({label:`${t.payerName} (${t.telephone||t.email||"N/A"})`,value:t.payerUuid}))),X=H(()=>{if(!g.value)return[];const t=C.value.find(e=>e.payerUuid===g.value);return!t||!t.contracts?[]:t.contracts.map(e=>({label:e.contractName,value:e.contractHeaderUuid}))});async function ue(){var t;try{p.value=!0,l.value=null;const e=await _e({page:1,limit:100});if(!((t=e==null?void 0:e.data)!=null&&t.content)||!Array.isArray(e.data.content))throw new Error("Invalid data format: missing content array");C.value=e.data.content.map(s=>({payerUuid:s.payerUuid,payerName:s.payerName||`Unnamed Payer (${s.email})`,email:s.email,telephone:s.telephone,contracts:s.contracts||[]})),C.value.length===0&&(l.value="No payers available")}catch(e){console.error("Error fetching payers:",e),l.value="Failed to load payers. Please try again."}finally{p.value=!1}}async function Y(){var t;if(!(!g.value||!y.value))try{p.value=!0,l.value=null;const e=await Ie(y.value,{search:r.value});if(!((t=e==null?void 0:e.data)!=null&&t.insuredSummaries)||!Array.isArray(e.data.insuredSummaries))throw new Error("Invalid employee data format: insuredSummaries not found in response.data");x.value=e.data.insuredSummaries.flatMap(s=>{var c;const i={insuredUuid:s.insuredUuid,fullName:s.fullName,membershipNumber:s.membershipNumber||"N/A",phone:"",email:"",gender:"",address:"",eligible:!0,position:"Employee",idNumber:s.membershipNumber||"N/A",birthDate:"",profilePictureBase64:null,status:"ACTIVE",isDependant:!1,dependants:s.dependants||[]},F=((c=s.dependants)==null?void 0:c.map(I=>({insuredUuid:I.dependantUuid,fullName:I.fullName,phone:"",email:"",gender:"",address:"",eligible:!0,position:`Dependant (${I.relationshipType})`,idNumber:"N/A",birthDate:"",profilePictureBase64:null,status:"ACTIVE",isDependant:!0,employeeId:s.membershipNumber||"N/A",relationshipType:I.relationshipType,employeeUuid:s.insuredUuid})))||[];return[i,...F]}),x.value.length===0&&(l.value="No employees found for this contract")}catch(e){console.error("Error fetching employees:",e),l.value=`Failed to load employees: ${e.message}`}finally{p.value=!1}}function Z(t){a.value={...t,isDependant:t.isDependant||!1,employeeUuid:t.isDependant?t.employeeUuid:t.insuredUuid,dependantUuid:t.isDependant?t.insuredUuid:null}}async function oe(){a.value&&(S.value="selectServices")}async function ce({type:t,query:e}){var s,i,F;try{p.value=!0;const c=(s=a.value)==null?void 0:s.isDependant,I=(i=a.value)==null?void 0:i.insuredUuid,Q=await Ce(y.value,I,c,e),Ue=((F=Q.data)==null?void 0:F.content)||Q.data||[];O.value?O.value.setSearchResults(Ue):console.error("selectServicesRef is not available")}catch(c){console.error("Error searching items:",c)}finally{p.value=!1}}function pe(t){L.value=t}function ve(t){h.value==="services"?v.value.push(t):d.value.push(t)}function me(t){h.value==="services"?v.value.splice(t,1):d.value.splice(t,1)}function ye({index:t,value:e}){h.value==="services"?v.value[t].quantity=e:d.value[t].quantity=e}function ge({index:t,primaryDiagnosis:e,secondaryDiagnosis:s}){e!==void 0&&(v.value[t].primaryDiagnosis=e),s!==void 0&&(v.value[t].secondaryDiagnosis=s)}function be({index:t,item:e}){h.value==="drugs"&&(d.value[t]={...d.value[t],...e})}function he(t){t==="services"?d.value=[]:v.value=[]}B([v,d],()=>{console.log("Current services:",v.value),console.log("Current drugs:",d.value)},{deep:!0}),B(a,t=>{t&&console.log("Current employee data:",{fullName:t.fullName,isDependant:t.isDependant,insuredUuid:t.insuredUuid,dependantUuid:t.dependantUuid,employeeUuid:t.employeeUuid})},{immediate:!0,deep:!0});function fe(){if(!a.value){R.error("No employee selected");return}const t=a.value.isDependant,e={providerUuid:_.value,payerUuid:g.value,contractHeaderUuid:y.value,insuredUuid:t?a.value.employeeUuid:a.value.insuredUuid,dependantUuid:t?a.value.insuredUuid:null,patientName:a.value.fullName,medicationItems:[...v.value.map(s=>(s.contractDetailUuid||console.error("Service missing contractDetailUuid:",s),{contractDetailUuid:s.contractDetailUuid,serviceUuid:s.serviceUuid,itemType:"SERVICE",remark:s.remark||"",quantity:s.quantity||1,price:s.price||0})),...d.value.map(s=>(s.contractDetailUuid||console.error("Drug missing contractDetailUuid:",s),{contractDetailUuid:s.contractDetailUuid,drugUuid:s.drugUuid,itemType:"DRUG",quantity:s.quantity||1,price:s.price||0,route:s.route||"oral",frequency:s.frequency||"daily",dose:s.dose||"1",duration:s.duration||"7 days"}))].filter(s=>s.contractDetailUuid),dispensingDate:A.value,prescriptionNumber:o.value,pharmacyTransactionId:f.value,primaryDiagnosis:T.value,secondaryDiagnosis:P.value};console.log("Final submission data:",e),E.onSubmit(e)}De(async()=>{await ue()});let J;return B(r,async t=>{clearTimeout(J),J=setTimeout(async()=>{g.value&&await Y()},300)}),B(g,async t=>{y.value=null}),B(y,async t=>{t&&await Y()}),(t,e)=>(m(),j(Se,{ref:"formEl",inner:!1,id:"credit-service-form",class:"bg-white rounded-lg shadow-sm",onSubmit:Ne(fe,["prevent"])},{default:q(({})=>{var s;return[S.value==="selectEmployee"?(m(),U("div",Me,[l.value?(m(),U("div",Ve,D(l.value),1)):k("",!0),n("div",je,[n("div",Oe,[b(ae,{obj:!0,name:"payer",label:"Select Payer",validation:"required",options:le.value,disabled:p.value,attributes:{placeholder:"Select a Payer"},modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=i=>g.value=i)},null,8,["options","disabled","modelValue"])]),g.value&&X.value.length>0?(m(),U("div",Qe,[b(ae,{obj:!0,name:"contract",label:"Select Contract",validation:"required",options:X.value,disabled:p.value,attributes:{placeholder:"Select a Contract"},modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=i=>y.value=i)},null,8,["options","disabled","modelValue"])])):k("",!0),n("div",He,[b(M,{name:"searchEmployeeQuery",label:"Search Employees",attributes:{placeholder:"Search employees"},modelValue:r.value,"onUpdate:modelValue":e[2]||(e[2]=i=>r.value=i)},null,8,["modelValue"])])]),n("div",ze,[p.value?(m(),U("div",Ge,[b(we,{class:"h-8 w-8 text-teal-600"})])):(m(),U("div",Le,[n("div",We,[n("table",Xe,[e[15]||(e[15]=n("thead",{class:"bg-gray-50 sticky top-0 z-10"},[n("tr",null,[n("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"#"),n("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Membership #"),n("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Patient Name"),n("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Type"),n("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Eligibility"),n("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Action")])],-1)),n("tbody",Ye,[(m(!0),U(z,null,te(x.value,(i,F)=>(m(),U(z,{key:i.insuredUuid},[i.isDependant?k("",!0):(m(),U("tr",{key:0,class:V({"bg-[#DFF1F1]":a.value&&a.value.insuredUuid===i.insuredUuid,"border-b-2 border-blue-200":i.dependants&&i.dependants.length>0})},[n("td",Ze,D(F+1),1),n("td",Je,D(i.membershipNumber),1),n("td",Ke,D(i.fullName),1),e[9]||(e[9]=n("td",{class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"}," Employee ",-1)),e[10]||(e[10]=n("td",{class:"px-6 py-4 whitespace-nowrap text-sm font-bold"},[n("span",{class:"bg-[#DFF1F1] text-[#02676B] p-1"}," Eligible ")],-1)),n("td",ea,[n("button",{type:"button",onClick:c=>Z(i),class:V({"text-white bg-[#02676B] px-4 py-2 hover:bg-teal-900":!(a.value&&a.value.insuredUuid===i.insuredUuid),"text-white bg-[#02676B] px-4 py-2 rounded":a.value&&a.value.insuredUuid===i.insuredUuid})},D(a.value&&a.value.insuredUuid===i.insuredUuid?"Selected":"Select"),11,aa)])],2)),!i.isDependant&&i.dependants&&i.dependants.length>0?(m(!0),U(z,{key:1},te(i.dependants,(c,I)=>(m(),U("tr",{key:c.dependantUuid,class:V(["bg-blue-50",{"bg-blue-100":a.value&&a.value.insuredUuid===c.dependantUuid}])},[n("td",ta,[e[11]||(e[11]=n("span",{class:"text-blue-600"},"â†³",-1)),$(" "+D(I+1),1)]),n("td",sa,[$(D(i.membershipNumber)+" ",1),e[12]||(e[12]=n("span",{class:"text-xs text-gray-400"},"(Employee ID)",-1))]),n("td",ia,[$(D(c.fullName)+" ",1),n("span",na,"(Dependant - "+D(c.relationshipType)+")",1)]),e[13]||(e[13]=n("td",{class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"}," Dependant ",-1)),e[14]||(e[14]=n("td",{class:"px-6 py-4 whitespace-nowrap text-sm font-bold"},[n("span",{class:"bg-[#DFF1F1] text-[#02676B] p-1"}," Eligible ")],-1)),n("td",ra,[n("button",{type:"button",onClick:Q=>Z({insuredUuid:c.dependantUuid,fullName:c.fullName,phone:i.phone,idNumber:i.membershipNumber,position:`Dependant (${c.relationshipType})`,birthDate:"",eligible:!0,status:"ACTIVE",gender:"",email:i.email,address:i.address,isDependant:!0,dependantUuid:c.dependantUuid,employeeUuid:i.insuredUuid,relationshipType:c.relationshipType,membershipNumber:i.membershipNumber}),class:V({"text-white bg-[#02676B] px-4 py-2 hover:bg-teal-900":!(a.value&&a.value.insuredUuid===c.dependantUuid),"text-white bg-[#02676B] px-4 py-2 rounded":a.value&&a.value.insuredUuid===c.dependantUuid})},D(a.value&&a.value.insuredUuid===c.dependantUuid?"Selected":"Select"),11,da)])],2))),128)):k("",!0)],64))),128))])])])]))]),a.value?(m(),U("div",la,[b(se,{type:"button",onClick:E.onCancel,class:"text-[#75778B] px-6 py-4 border-[1px] border-[#75778B] rounded-lg hover:bg-gray-50",disabled:p.value},{default:q(()=>e[16]||(e[16]=[$(" Cancel ")])),_:1,__:[16]},8,["onClick","disabled"]),n("button",{type:"button",class:"px-6 py-2 bg-primary text-white rounded-md hover:bg-teal-700",onClick:oe}," Continue to Services ")])):k("",!0)])):W.value?(m(),U("div",ua,[l.value?(m(),U("div",oa,D(l.value),1)):k("",!0),b($e,{employee:W.value},null,8,["employee"]),n("div",ca,[n("div",null,[b(M,{modelValue:o.value,"onUpdate:modelValue":e[3]||(e[3]=i=>o.value=i),name:"prescriptionNumber",label:"Prescription Number",validation:"required",attributes:{placeholder:"Enter prescription number"}},null,8,["modelValue"])]),n("div",null,[b(M,{modelValue:f.value,"onUpdate:modelValue":e[4]||(e[4]=i=>f.value=i),name:"pharmacyTransactionId",label:"Pharmacy Transaction ID",validation:"required",attributes:{placeholder:"Enter pharmacy transaction ID"}},null,8,["modelValue"])]),n("div",null,[b(M,{modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=i=>A.value=i),name:"dispensingDate",label:"Dispensing Date",validation:"required",attributes:{type:"date",placeholder:"Select dispensing date",required:!0}},null,8,["modelValue"])])]),b(Re,{ref_key:"selectServicesRef",ref:O,activeTab:h.value,"onUpdate:activeTab":e[6]||(e[6]=i=>h.value=i),"added-items":h.value==="services"?v.value:d.value,remarks:L.value,"primary-diagnosis":T.value,"secondary-diagnosis":P.value,"insured-uuid":(s=a.value)==null?void 0:s.insuredUuid,"contract-header-uuid":y.value,"onUpdate:remarks":pe,onAddItem:ve,onRemoveItem:me,onUpdateQuantity:ye,onUpdateDiagnosis:ge,onUpdateItem:be,onSearchItems:ce,onClearItems:he,"onUpdate:primaryDiagnosis":e[7]||(e[7]=i=>T.value=i),"onUpdate:secondaryDiagnosis":e[8]||(e[8]=i=>P.value=i)},null,8,["activeTab","added-items","remarks","primary-diagnosis","secondary-diagnosis","insured-uuid","contract-header-uuid"]),n("div",pa,[b(se,{type:"button",onClick:N.onCancel,class:"text-[#75778B] px-6 py-4 border-[1px] border-[#75778B] rounded-lg hover:bg-gray-50",disabled:N.pending},{default:q(()=>e[17]||(e[17]=[$(" Back ")])),_:1,__:[17]},8,["onClick","disabled"]),h.value==="services"?(m(),j(ie,{key:0,pending:N.pending,"btn-text":"Add Service to Credit",class:"bg-primary hover:bg-teal-700 text-white px-6 py-2",disabled:N.pending},null,8,["pending","disabled"])):h.value==="drugs"?(m(),j(ie,{key:1,pending:N.pending,"btn-text":"Add Drug to Credit",class:"bg-primary hover:bg-teal-700 text-white px-6 py-2",disabled:N.pending},null,8,["pending","disabled"])):k("",!0)])])):k("",!0)]}),_:1},512))}},ma=xe(va,[["__scopeId","data-v-37201195"]]),ya=re({__name:"creditServicesFormDataProvider",setup(N,{expose:E}){const C=G();ke();const x=u(!1);async function g(a){var y,r,p;try{x.value=!0;const l=a.drugItems!==void 0,S={providerUuid:((r=(y=C.auth)==null?void 0:y.user)==null?void 0:r.providerUuid)||"",payerUuid:a.payerUuid,payerName:a.payerName||"",phone:a.phone,employeeId:a.employeeId,insuredUuid:a.insuredUuid,dispensingDate:a.dispensingDate,prescriptionNumber:a.prescriptionNumber,pharmacyTransactionId:a.pharmacyTransactionId,...l?{drugItems:a.drugItems.map(d=>({...d,totalPrice:d.totalPrice||(d.price||0)*(d.quantity||1)}))}:{medicationItems:((p=a.serviceItems)==null?void 0:p.map(d=>({serviceUuid:d.serviceUuid,primaryDiagnosis:d.primaryDiagnosis||"",secondaryDiagnosis:d.secondaryDiagnosis||"",totalPrice:d.totalPrice||0})))||[]}},v=await(l?Te:de)(S);if(v.success)return R(!0,l?"Credit drug created successfully":"Credit service created successfully"),v;throw new Error(v.error||"Failed to create credit")}catch(l){const S=l instanceof Error?l.message:"Credit creation failed";throw R(!1,S),l}finally{x.value=!1}}return E({createCredit:g,pending:x}),(a,y)=>Ee(a.$slots,"default",{createCredit:g,pending:x.value})}}),ga={class:"bg-white rounded-lg"},fa=re({__name:"AddCreditServices.mdl",setup(N){const E=Pe(),C=G(),x=u(!1),g=Ae(),a=u();async function y(r){var p,l,S,h,v,d,T,P;try{if(x.value=!0,!r.payerUuid||!r.dispensingDate||!r.insuredUuid&&!r.dependantUuid)throw new Error("Please fill all required fields");if(!r.medicationItems||r.medicationItems.length===0)throw new Error("Please add at least one medication item");const w={providerUuid:((l=(p=C.auth)==null?void 0:p.user)==null?void 0:l.providerUuid)||"",payerUuid:r.payerUuid,insuredUuid:r.insuredUuid,contractHeaderUuid:r.contractHeaderUuid,dependantUuid:r.dependantUuid,phone:r.phone,patientName:r.patientName||`${r.employeeId} - ${r.phone}`,employeeId:r.employeeId,dispensingDate:r.dispensingDate,prescriptionNumber:r.prescriptionNumber||"",pharmacyTransactionId:r.pharmacyTransactionId||"",primaryDiagnosis:r.primaryDiagnosis||"",secondaryDiagnosis:r.secondaryDiagnosis||"",medicationItems:r.medicationItems.map(o=>({contractDetailUuid:o.contractDetailUuid||"",itemType:o.itemType,remark:o.remark||"",price:o.price||(o.itemType==="SERVICE"?typeof o.paymentAmount=="string"?parseFloat(o.paymentAmount.replace("ETB ",""))||0:Number(o.paymentAmount)||0:o.price||0),quantity:Number(o.quantity)||1,...o.itemType==="DRUG"?{route:o.route||"oral",frequency:o.frequency||"daily",dose:o.dose||"1",duration:o.duration||"7 days"}:{}}))},_=await de(w);if(_.success){const o={...w,invoiceNumber:((S=_.data)==null?void 0:S.invoiceNumber)||`TEMP-${Date.now()}`,dispensingUuid:((h=_.data)==null?void 0:h.dispensingUuid)||`TEMP-${Date.now()}`,totalAmount:w.medicationItems.reduce((f,A)=>f+(A.price||0)*(Number(A.quantity)||1),0),patientResponsibility:0,insuranceCoverage:0,branchName:null,createdAt:new Date().toISOString(),items:w.medicationItems.map(f=>({...f,name:f.itemType==="SERVICE"?f.serviceName:f.drugName,code:f.itemType==="SERVICE"?f.serviceCode:f.drugCode}))};R(!0,"Success",((v=_.data)==null?void 0:v.message)||"Credit claim added successfully"),E.add(o),ne(),g.push("/credit_services")}else throw new Error(((d=_.data)==null?void 0:d.message)||"Submission failed")}catch(w){console.error("Submission error:",w);const _=((P=(T=w.response)==null?void 0:T.data)==null?void 0:P.message)||w.message||"Failed to process credit request";R(!1,"Error",_)}finally{x.value=!1}}return(r,p)=>(m(),j(Be,null,{default:q(()=>[b(Fe,{class:"",size:"xl",title:"Add New Credit Claim",subtitle:"To add a new credit claim, please fill out the information in the fields below."},{default:q(()=>[n("div",ga,[b(ya,{ref_key:"formDataProvider",ref:a},{default:q(({pending:l})=>[b(ma,{pending:x.value||l,onSubmit:y,onCancel:()=>qe(ne)()},null,8,["pending","onCancel"])]),_:1},512)])]),_:1})]),_:1}))}});export{fa as default};
